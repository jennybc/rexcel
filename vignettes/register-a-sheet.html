<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Jennifer Bryan" />

<meta name="date" content="2016-06-09" />

<title>Register an Excel Sheet</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Register an Excel Sheet</h1>
<h4 class="author"><em>Jennifer Bryan</em></h4>
<h4 class="date"><em>2016-06-09</em></h4>


<div id="TOC">
<ul>
<li><a href="#example-sheets">Example sheets</a></li>
<li><a href="#walk-through-rexcel_register">Walk through <code>rexcel_register()</code></a></li>
<li><a href="#manifest-file-list"><code>manifest</code> = file list</a></li>
<li><a href="#content_types.xml">[Content_Types].xml</a></li>
<li><a href="#sheets-info-from-xlworkbook.xml"><code>sheets</code> info from xl/workbook.xml</a></li>
<li><a href="#named-ranges-from-xlworkbook.xml">Named ranges from xl/workbook.xml</a></li>
<li><a href="#workbook-rels-from-xl_relsworkbook.xml.rels">Workbook rels from xl/_rels/workbook.xml.rels</a></li>
<li><a href="#derived-object-sheets_df">Derived object: <code>sheets_df</code></a></li>
<li><a href="#shared-strings-from-xlsharedstrings.xml">Shared strings from xl/sharedStrings.xml</a></li>
<li><a href="#styles-from-xlstyles.xml">Styles from xl/styles.xml</a></li>
<li><a href="#worksheet-rels-from-xlworksheets_relssheet0-9.xml.rels">Worksheet rels from xl/worksheets/_rels/sheet[0-9]*.xml.rels</a></li>
<li><a href="#drawings-such-as-xldrawingsworksheetdrawing1.xml">Drawings such as xl/drawings/worksheetdrawing1.xml</a></li>
<li><a href="#high-level-info-from-worksheets">High-level info from worksheets</a></li>
<li><a href="#putting-it-all-together">Putting it all together</a></li>
<li><a href="#relating-this-to-rexcel_read_workbook">Relating this to <code>rexcel_read_workbook()</code></a></li>
</ul>
</div>

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rprojroot)
devtools::<span class="kw">load_all</span>(<span class="kw">find_package_root_file</span>())</code></pre></div>
<pre><code>## Loading rexcel</code></pre>
<p>A walk through the code in <code>rexcel_register()</code>. I wrote this function to make myself better acquainted with the files that make up an xlsx and with <code>rexcel</code>. It could evolve into something useful and/or some of this could be incorporated into <code>rexcel_read_workbook()</code> or <code>rexcel_read_worksheet()</code>.</p>
<p>Philosophy, at least in theory:</p>
<ul>
<li>Don’t error unless it’s an invalid xlsx file. Try to do something useful, even if it’s mostly informative messages about why something can’t be read in.</li>
<li>Inner functions are typically of this form: <code>xlsx_read_*()</code>.
<ul>
<li>They always take <code>path</code> to xlsx as primary or only argument.</li>
<li>They read from exactly one file.</li>
<li>We have one to read every file that’s there. <em>probably very untrue, in practice! since I create a manifest, I could actually check this …</em></li>
</ul></li>
<li>Process data read from xlsx files only enough to create the minimal R object.</li>
<li>Inner functions always return a single object.</li>
<li>Why all of this? So it’s easy to “drop in” on a problematic xlsx or to work on <code>rexcel</code>. I find it hard to do this when low-level functions work with lists that combine different objects and objects that come from different files. If you haven’t run a bunch of other internal code first (or if some of that failed), it’s hard to get into a good place for figuring out what’s wrong.</li>
</ul>
<div id="example-sheets" class="section level3">
<h3>Example sheets</h3>
<p>We illustrate different xlsx features using different example sheets. Pre-store their paths to make this easier.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mini_gap_path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;sheets&quot;</span>, <span class="st">&quot;mini-gap.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;rexcel&quot;</span>)
ff_path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;sheets&quot;</span>, <span class="st">&quot;gs-test-formula-formatting.xlsx&quot;</span>,
                       <span class="dt">package =</span> <span class="st">&quot;rexcel&quot;</span>)
ek_path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;sheets&quot;</span>, <span class="st">&quot;Ekaterinburg_IP_9.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;rexcel&quot;</span>)
ek2_path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;sheets&quot;</span>, <span class="st">&quot;Ekaterinburg_IP_9-RESAVED.xlsx&quot;</span>,
                        <span class="dt">package =</span> <span class="st">&quot;rexcel&quot;</span>)
dn_path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;sheets&quot;</span>, <span class="st">&quot;defined-names.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;rexcel&quot;</span>)
gabe_path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;sheets&quot;</span>, <span class="st">&quot;gabe.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;rexcel&quot;</span>)</code></pre></div>
</div>
<div id="walk-through-rexcel_register" class="section level3">
<h3>Walk through <code>rexcel_register()</code></h3>
<p><code>path</code> is path to the xlsx and is the only argument. We’ll use different example sheets as we go. Let’s start with mini Gapminder.</p>
<p><code>is_xlsx()</code> runs sanity checks to make sure this looks like valid xlsx.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is_xlsx</span>(mini_gap_path)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="manifest-file-list" class="section level3">
<h3><code>manifest</code> = file list</h3>
<p><code>manifest</code> holds a list of files in the zip archive.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">manifest &lt;-<span class="st"> </span><span class="kw">xlsx_list_files</span>(mini_gap_path)
<span class="kw">print</span>(manifest, <span class="dt">n =</span> <span class="ot">Inf</span>)</code></pre></div>
<pre><code>## Source: local data frame [21 x 3]
## 
##                                   name length                date
##                                  &lt;chr&gt;  &lt;dbl&gt;              &lt;time&gt;
## 1                  [Content_Types].xml   2005 2015-04-25 12:00:00
## 2                          _rels/.rels    296 2015-04-25 12:00:00
## 3           xl/_rels/workbook.xml.rels   1129 2015-04-25 12:00:00
## 4    xl/drawings/worksheetdrawing1.xml    494 2015-04-25 12:00:00
## 5    xl/drawings/worksheetdrawing2.xml    494 2015-04-25 12:00:00
## 6    xl/drawings/worksheetdrawing3.xml    494 2015-04-25 12:00:00
## 7    xl/drawings/worksheetdrawing4.xml    494 2015-04-25 12:00:00
## 8    xl/drawings/worksheetdrawing5.xml    494 2015-04-25 12:00:00
## 9                 xl/sharedStrings.xml    942 2015-04-25 12:00:00
## 10                       xl/styles.xml   1070 2015-04-25 12:00:00
## 11                     xl/workbook.xml    980 2015-04-25 12:00:00
## 12 xl/worksheets/_rels/sheet1.xml.rels    307 2015-04-25 12:00:00
## 13 xl/worksheets/_rels/sheet2.xml.rels    307 2015-04-25 12:00:00
## 14 xl/worksheets/_rels/sheet3.xml.rels    307 2015-04-25 12:00:00
## 15 xl/worksheets/_rels/sheet4.xml.rels    307 2015-04-25 12:00:00
## 16 xl/worksheets/_rels/sheet5.xml.rels    307 2015-04-25 12:00:00
## 17            xl/worksheets/sheet1.xml   2136 2015-04-25 12:00:00
## 18            xl/worksheets/sheet2.xml   2136 2015-04-25 12:00:00
## 19            xl/worksheets/sheet3.xml   2146 2015-04-25 12:00:00
## 20            xl/worksheets/sheet4.xml   2136 2015-04-25 12:00:00
## 21            xl/worksheets/sheet5.xml   2144 2015-04-25 12:00:00</code></pre>
<p>Overview of manifests I’ve seen. <em>TO DO: cross-check/enhance this with some actual research in the spec or other resources we like.</em></p>
<ul>
<li>Workbook infrastructure
<ul>
<li>[Content_Types].xml</li>
<li>_rels/.rels <em>boring? I don’t currently process</em></li>
<li>xl/workbook.xml</li>
<li>xl/_rels/workbook.xml.rels</li>
<li>xl/sharedStrings.xml <em>doesn’t necessarily exist</em></li>
<li>xl/styles.xml</li>
<li>docProps/core.xml <em>have never looked at one of these; we have one in defined_names.xlsx</em></li>
<li>docProps/app.xml <em>ditto</em></li>
</ul></li>
<li>Worksheet: one main file per sheet
<ul>
<li>xl/worksheets/sheet1.xml, xl/worksheets/sheet2.xml, … is typical</li>
<li>but xl/worksheets/sheet.xml is also possible!</li>
<li>this is where sheet data actually lives, up to complications like the shared strings</li>
</ul></li>
<li>Worksheet: a <code>rels</code> file for each sheet
<ul>
<li>xl/worksheets/_rels/sheet1.xml.rels and so on</li>
</ul></li>
<li>Worksheet: a file of drawings?
<ul>
<li>xl/drawings/worksheetdrawing1.xml and so on</li>
<li><em>you don’t necessarily have these, but I see them even when there are no “drawings”</em></li>
</ul></li>
</ul>
<p>The Ekaterinburg sheet from <a href="https://github.com/hadley/readxl/issues/80">readxl/#80</a> has unusual structure. It was created by an undisclosed BI system but I include it here because the R packages that <a href="https://poi.apache.org/spreadsheet/index.html">wrap the Apache POI</a> can read it just fine. So we should be able to return something informative for it.</p>
<p>Note the single sheet is referred to as <code>sheet</code>, not <code>sheet1</code>, and there is no associated <code>drawings</code> file.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">xlsx_list_files</span>(ek_path), <span class="dt">n =</span> <span class="ot">Inf</span>)</code></pre></div>
<pre><code>## Source: local data frame [8 x 3]
## 
##                                 name  length                date
##                                &lt;chr&gt;   &lt;dbl&gt;              &lt;time&gt;
## 1                [Content_Types].xml     736 2014-10-23 16:38:00
## 2                        _rels/.rels     296 2014-10-23 16:38:00
## 3         xl/_rels/workbook.xml.rels     603 2014-10-23 16:38:00
## 4               xl/sharedStrings.xml   41835 2014-10-23 16:38:00
## 5                      xl/styles.xml    4614 2014-10-23 16:38:00
## 6                    xl/workbook.xml     314 2014-10-23 16:38:00
## 7 xl/worksheets/_rels/sheet.xml.rels     322 2014-10-23 16:38:00
## 8            xl/worksheets/sheet.xml 1922092 2014-10-23 16:38:00</code></pre>
<p>If you open that workbook in Excel and resave it, things look different.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">xlsx_list_files</span>(ek2_path), <span class="dt">n =</span> <span class="ot">Inf</span>)</code></pre></div>
<pre><code>## Source: local data frame [11 x 3]
## 
##                                   name  length       date
##                                  &lt;chr&gt;   &lt;dbl&gt;     &lt;time&gt;
## 1                  [Content_Types].xml    1168 1980-01-01
## 2                          _rels/.rels     588 1980-01-01
## 3                     docProps/app.xml     795 1980-01-01
## 4                    docProps/core.xml     589 1980-01-01
## 5           xl/_rels/workbook.xml.rels     698 1980-01-01
## 6                 xl/sharedStrings.xml  589203 1980-01-01
## 7                        xl/styles.xml    2856 1980-01-01
## 8                  xl/theme/theme1.xml    6788 1980-01-01
## 9                      xl/workbook.xml    1336 1980-01-01
## 10 xl/worksheets/_rels/sheet1.xml.rels     324 1980-01-01
## 11            xl/worksheets/sheet1.xml 1072131 1980-01-01</code></pre>
<p>We gain <code>docProps/app.xml</code>, <code>docProps/core.xml</code>, and <code>xl/theme/theme1.xml</code> and the single sheet is now referred to as <code>sheet1</code>, not just <code>sheet</code>. Still no drawings, though.</p>
<p>Conclusion: there is a lot of variety in the manifest for valid xlsx.</p>
</div>
<div id="content_types.xml" class="section level3">
<h3>[Content_Types].xml</h3>
<p>The <code>ct</code> object created from <code>[Content_Types].xml</code> is a tibble associating content types with extensions or specific files:</p>
<ul>
<li>two “general” rows for the extensions <code>.xml</code> and <code>.rels</code></li>
<li>other rows for specific files seen in the manifest <em>I gather these override the general types associated with extensions?</em></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(ct &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">xlsx_read_Content_Types</span>(mini_gap_path)))</code></pre></div>
<pre><code>##                             part_name extension
## 1                                &lt;NA&gt;      rels
## 2                                &lt;NA&gt;       xml
## 3  /xl/drawings/worksheetdrawing4.xml      &lt;NA&gt;
## 4  /xl/drawings/worksheetdrawing2.xml      &lt;NA&gt;
## 5  /xl/drawings/worksheetdrawing1.xml      &lt;NA&gt;
## 6  /xl/drawings/worksheetdrawing3.xml      &lt;NA&gt;
## 7  /xl/drawings/worksheetdrawing5.xml      &lt;NA&gt;
## 8                      /xl/styles.xml      &lt;NA&gt;
## 9               /xl/sharedStrings.xml      &lt;NA&gt;
## 10                   /xl/workbook.xml      &lt;NA&gt;
## 11          /xl/worksheets/sheet5.xml      &lt;NA&gt;
## 12          /xl/worksheets/sheet3.xml      &lt;NA&gt;
## 13          /xl/worksheets/sheet1.xml      &lt;NA&gt;
## 14          /xl/worksheets/sheet4.xml      &lt;NA&gt;
## 15          /xl/worksheets/sheet2.xml      &lt;NA&gt;
##                                                                     content_type
## 1                       application/vnd.openxmlformats-package.relationships+xml
## 2                                                                application/xml
## 3                      application/vnd.openxmlformats-officedocument.drawing+xml
## 4                      application/vnd.openxmlformats-officedocument.drawing+xml
## 5                      application/vnd.openxmlformats-officedocument.drawing+xml
## 6                      application/vnd.openxmlformats-officedocument.drawing+xml
## 7                      application/vnd.openxmlformats-officedocument.drawing+xml
## 8         application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml
## 9  application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml
## 10    application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml
## 11     application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml
## 12     application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml
## 13     application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml
## 14     application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml
## 15     application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#setdiff(manifest$name, gsub(&quot;^\\/&quot;, &quot;&quot;, ct$part_name))</span>
<span class="co">#intersect(gsub(&quot;^\\/&quot;, &quot;&quot;, ct$part_name), manifest$name)</span></code></pre></div>
</div>
<div id="sheets-info-from-xlworkbook.xml" class="section level3">
<h3><code>sheets</code> info from xl/workbook.xml</h3>
<p>Among many other things in <code>xl/workbook.xml</code>, there is one xml node per worksheet, which we use to make <code>sheets</code>. It’s a tibble with one row per worksheet and these variables:</p>
<ul>
<li><code>name</code>: e.g., “Africa” <em>I assume this is name of the tab</em></li>
<li><code>state</code>: “visible” <em>or what else … “invisible”?; might be <code>NA</code></em></li>
<li><code>sheet_id</code>: integer <em>I assume this is order perceived by user</em></li>
<li><code>id</code>: character, e.g., <code>&quot;rId5&quot;</code> <em>a key that comes up elsewhere</em></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(sheets &lt;-<span class="st"> </span><span class="kw">xlsx_read_workbook_sheets</span>(mini_gap_path))</code></pre></div>
<pre><code>## Source: local data frame [5 x 4]
## 
##       name   state sheet_id    id
##      &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
## 1   Africa visible        1  rId3
## 2 Americas visible        2  rId4
## 3     Asia visible        3  rId5
## 4   Europe visible        4  rId6
## 5  Oceania visible        5  rId7</code></pre>
<p>Quick tour of similar info for other example sheets:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_sheets</span>(ff_path)</code></pre></div>
<pre><code>## Source: local data frame [1 x 4]
## 
##     name   state sheet_id    id
##    &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
## 1 Sheet1 visible        1  rId3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_sheets</span>(ek_path)</code></pre></div>
<pre><code>## Source: local data frame [1 x 4]
## 
##             name state sheet_id                id
##            &lt;chr&gt; &lt;chr&gt;    &lt;int&gt;             &lt;chr&gt;
## 1 СПАРК - Список  &lt;NA&gt;        1 R6082ddd3e995440f</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_sheets</span>(ek2_path)</code></pre></div>
<pre><code>## Source: local data frame [1 x 4]
## 
##             name state sheet_id    id
##            &lt;chr&gt; &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
## 1 СПАРК - Список  &lt;NA&gt;        1  rId1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_sheets</span>(dn_path)</code></pre></div>
<pre><code>## Source: local data frame [1 x 4]
## 
##     name state sheet_id    id
##    &lt;chr&gt; &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
## 1 Sheet1  &lt;NA&gt;        1  rId1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_sheets</span>(gabe_path)</code></pre></div>
<pre><code>## Source: local data frame [2 x 4]
## 
##             name state sheet_id    id
##            &lt;chr&gt; &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
## 1 Gabe's S''heet  &lt;NA&gt;        2  rId1
## 2     HiGabe!!!!  &lt;NA&gt;        1  rId2</code></pre>
</div>
<div id="named-ranges-from-xlworkbook.xml" class="section level3">
<h3>Named ranges from xl/workbook.xml</h3>
<p>Cell ranges can be named in Excel and subsequently used in formulas. These are described in <code>xl/workbook.xml</code> in the <code>definedName</code> nodes. Jenny has seen one node structure in the example she created, which differs from what Rich anticipated (presumably based on the spec?). Furthermore, Ekaterinburg has novel namespacing as well. See the comments in source for <code>xlsx_read_workbook_defined_names()</code> for details. Expect future pain here.</p>
<p>If a workbook has no named ranges, this will be <code>NULL</code>, e.g., as for mini Gapminder. Currently we have two example sheets with named ranges, <code>defined-names.xlsx</code> and <code>gabe.xlsx</code>. <code>defined-names.xlsx</code> was a planned example sheet. <code>gabe.xlsx</code> was intended just to explore weird worksheet names but, since it was copied from <code>defined-names.xlsx</code> and then worksheets got copied again, it incidentally shows what happens when there are replicated range names.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_defined_names</span>(mini_gap_path)</code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_defined_names</span>(dn_path)</code></pre></div>
<pre><code>## Source: local data frame [6 x 4]
## 
##        name         refers_to sheet_id local_sheet_id
##       &lt;chr&gt;             &lt;chr&gt;    &lt;int&gt;          &lt;int&gt;
## 1 continent Sheet1!$B$2:$B$11       NA             NA
## 2   country Sheet1!$A$2:$A$11       NA             NA
## 3 gdpPercap Sheet1!$F$2:$F$11       NA             NA
## 4   lifeExp Sheet1!$D$2:$D$11       NA             NA
## 5       pop Sheet1!$E$2:$E$11       NA             NA
## 6      year Sheet1!$C$2:$C$11       NA             NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_defined_names</span>(gabe_path)</code></pre></div>
<pre><code>## Source: local data frame [4 x 4]
## 
##      name                     refers_to sheet_id local_sheet_id
##     &lt;chr&gt;                         &lt;chr&gt;    &lt;int&gt;          &lt;int&gt;
## 1   A_one      'Gabe''s S''''heet'!$A$1       NA              0
## 2   A_one             'HiGabe!!!!'!$A$1       NA             NA
## 3 numbers 'Gabe''s S''''heet'!$A$2:$A$6       NA              0
## 4 numbers        'HiGabe!!!!'!$A$2:$A$6       NA             NA</code></pre>
<p><code>defined_names</code> is a tibble with one row per named range and these variables:</p>
<ul>
<li><code>name</code>: name of the named range</li>
<li><code>refers_to</code>: string representation of the cell (area) reference, e.g., <code>Sheet1!$B$2:$B$11</code></li>
<li><code>sheet_id</code>: integer <em>I can’t get my hands on a sheet that has actually this?</em></li>
<li><code>local_sheet_id</code>: integer <em>appears when names are replicated</em></li>
</ul>
</div>
<div id="workbook-rels-from-xl_relsworkbook.xml.rels" class="section level3">
<h3>Workbook rels from xl/_rels/workbook.xml.rels</h3>
<p><em>We should probably cook up a more interesting example here.</em></p>
<p>Mini Gapminder is interesting because you see the sheets aren’t numbered exactly as you’d expect (which is <a href="https://github.com/hadley/readxl/issues/104"><code>hadley/readxl#104</code></a>). Ekaterinburg is also interesting because <code>target</code> has a leading slash and includes the <code>xl</code> subdirectory. But the re-saved version looks more conventional.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(workbook_rels &lt;-<span class="st"> </span><span class="kw">xlsx_read_workbook_rels</span>(mini_gap_path))</code></pre></div>
<pre><code>## Source: local data frame [7 x 3]
## 
##                  target    id
##                   &lt;chr&gt; &lt;chr&gt;
## 1     sharedStrings.xml  rId2
## 2            styles.xml  rId1
## 3 worksheets/sheet3.xml  rId4
## 4 worksheets/sheet4.xml  rId3
## 5 worksheets/sheet1.xml  rId6
## 6 worksheets/sheet5.xml  rId5
## 7 worksheets/sheet2.xml  rId7
## Variables not shown: type &lt;chr&gt;.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_rels</span>(ek_path)</code></pre></div>
<pre><code>## Source: local data frame [3 x 3]
## 
##                     target                id
##                      &lt;chr&gt;             &lt;chr&gt;
## 1    /xl/sharedStrings.xml Rfd88d28f71e84f97
## 2           /xl/styles.xml Ra71ceb88d7f8404d
## 3 /xl/worksheets/sheet.xml R6082ddd3e995440f
## Variables not shown: type &lt;chr&gt;.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_workbook_rels</span>(ek2_path)</code></pre></div>
<pre><code>## Source: local data frame [4 x 3]
## 
##                  target    id
##                   &lt;chr&gt; &lt;chr&gt;
## 1            styles.xml  rId3
## 2     sharedStrings.xml  rId4
## 3 worksheets/sheet1.xml  rId1
## 4      theme/theme1.xml  rId2
## Variables not shown: type &lt;chr&gt;.</code></pre>
<p><code>workbook_rels</code> is a tibble, each row a file, with variables</p>
<ul>
<li><code>target</code>: a file path relative to <code>xl/</code> <em>maybe I should prepend xl/?</em></li>
<li><code>id</code>: character, e.g., <code>&quot;rId5&quot;</code> <em>a key that occurs elsewhere</em></li>
<li><code>type</code>: a long namespace-y string, the last bit of which tells you if the associated file is <code>sharedStrings</code>, styles, or a worksheet, e.g., <code>http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet</code> <em>maybe I should retain just the last bit?</em></li>
</ul>
</div>
<div id="derived-object-sheets_df" class="section level3">
<h3>Derived object: <code>sheets_df</code></h3>
<p>We depart from the philosophy a bit here to create <code>sheets_df</code>, a new tibble with one row per worksheet. It joins <code>sheets</code>, which came from <code>workbook.xml</code>, to <code>workbook_rels</code>, which came from <code>workbook.xml.rels</code>. This is where we finally get sheet id, sheet name, id, and xml target file all in one place.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(sheets_df &lt;-<span class="st"> </span><span class="kw">join_sheets_workbook_rels</span>(sheets, workbook_rels))</code></pre></div>
<pre><code>## Source: local data frame [5 x 5]
## 
##   sheet_id     name    id                   target   state
##      &lt;int&gt;    &lt;chr&gt; &lt;chr&gt;                    &lt;chr&gt;   &lt;chr&gt;
## 1        1   Africa  rId3 xl/worksheets/sheet4.xml visible
## 2        2 Americas  rId4 xl/worksheets/sheet3.xml visible
## 3        3     Asia  rId5 xl/worksheets/sheet5.xml visible
## 4        4   Europe  rId6 xl/worksheets/sheet1.xml visible
## 5        5  Oceania  rId7 xl/worksheets/sheet2.xml visible</code></pre>
</div>
<div id="shared-strings-from-xlsharedstrings.xml" class="section level3">
<h3>Shared strings from xl/sharedStrings.xml</h3>
<p>Strings do not appear in the main sheet data files but rather appear exactly once in <code>sharedStrings.xml</code> and are then referenced.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(shared_strings &lt;-<span class="st"> </span><span class="kw">xlsx_read_shared_strings</span>(mini_gap_path))</code></pre></div>
<pre><code>##  [1] &quot;country&quot;                &quot;continent&quot;             
##  [3] &quot;year&quot;                   &quot;lifeExp&quot;               
##  [5] &quot;pop&quot;                    &quot;gdpPercap&quot;             
##  [7] &quot;Algeria&quot;                &quot;Africa&quot;                
##  [9] &quot;Angola&quot;                 &quot;Albania&quot;               
## [11] &quot;Europe&quot;                 &quot;Benin&quot;                 
## [13] &quot;Austria&quot;                &quot;Argentina&quot;             
## [15] &quot;Americas&quot;               &quot;Belgium&quot;               
## [17] &quot;Australia&quot;              &quot;Oceania&quot;               
## [19] &quot;Bolivia&quot;                &quot;Bosnia and Herzegovina&quot;
## [21] &quot;New Zealand&quot;            &quot;Bulgaria&quot;              
## [23] &quot;Brazil&quot;                 &quot;Canada&quot;                
## [25] &quot;Afghanistan&quot;            &quot;Asia&quot;                  
## [27] &quot;Bahrain&quot;                &quot;Chile&quot;                 
## [29] &quot;Bangladesh&quot;             &quot;Botswana&quot;              
## [31] &quot;Cambodia&quot;               &quot;China&quot;                 
## [33] &quot;Burkina Faso&quot;          
## attr(,&quot;count&quot;)
## [1] 80
## attr(,&quot;uniqueCount&quot;)
## [1] 33</code></pre>
<p><code>shared_strings</code> is a character vector, with attributes <code>count</code> (total # of strings?) and <code>uniqueCount</code> (its own length?).</p>
<p>Let’s look at some others. <strong>I have no idea what’s going on with Ekaterinburg original vs re-saved!</strong> Why do <code>count</code> and <code>uniqueCount</code> both blow up?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_shared_strings</span>(ff_path)</code></pre></div>
<pre><code>##  [1] &quot;integer&quot;           &quot;number_formatted&quot;  &quot;number_rounded&quot;   
##  [4] &quot;character&quot;         &quot;formula&quot;           &quot;formula_formatted&quot;
##  [7] &quot;one&quot;               &quot;three&quot;             &quot;four&quot;             
## [10] &quot;five&quot;             
## attr(,&quot;count&quot;)
## [1] 10
## attr(,&quot;uniqueCount&quot;)
## [1] 10</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(<span class="kw">xlsx_read_shared_strings</span>(ek_path))</code></pre></div>
<pre><code>##  atomic [1:165]   Исключен из Статрегистра ИП от 31.01.2014   Исключен из Статрегистра ИП от 31.01.2014   Исключен из Статрегистра ИП от 01.07.2014  ...
##  - attr(*, &quot;count&quot;)= int 2191
##  - attr(*, &quot;uniqueCount&quot;)= int 165</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(<span class="kw">xlsx_read_shared_strings</span>(ek2_path))</code></pre></div>
<pre><code>##  atomic [1:11354]  Исключен из Статрегистра ИП от 31.01.2014 Исключен из Статрегистра ИП от 31.01.2014 Исключен из Статрегистра ИП от 01.07.2014 ...
##  - attr(*, &quot;count&quot;)= int 24114
##  - attr(*, &quot;uniqueCount&quot;)= int 11354</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_shared_strings</span>(gabe_path)</code></pre></div>
<pre><code>## [1] &quot;numbers&quot;
## attr(,&quot;count&quot;)
## [1] 2
## attr(,&quot;uniqueCount&quot;)
## [1] 1</code></pre>
</div>
<div id="styles-from-xlstyles.xml" class="section level3">
<h3>Styles from xl/styles.xml</h3>
<p>Where to begin? I got as far as parsing the fonts. Then decided this, more anything else, was a ridiculous thing to re-do. Rich has made a great start on it. Revisit on a strict as needed basis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(styles &lt;-<span class="st"> </span><span class="kw">xlsx_read_style</span>(mini_gap_path))</code></pre></div>
<pre><code>## $fonts
## Source: local data frame [2 x 13]
## 
##    name family     b     i strike outline shadow condense extend   color
##   &lt;chr&gt;  &lt;chr&gt; &lt;lgl&gt; &lt;lgl&gt;  &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;    &lt;lgl&gt;  &lt;lgl&gt;   &lt;chr&gt;
## 1 Arial   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #000000
## 2  &lt;NA&gt;   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE    &lt;NA&gt;
## Variables not shown: sz &lt;dbl&gt;, u &lt;chr&gt;, scheme &lt;chr&gt;.
## 
## $fills
## Source: local data frame [2 x 4]
## 
##      type pattern_type    fg    bg
##     &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 pattern         none  &lt;NA&gt;  &lt;NA&gt;
## 2 pattern    lightGray  &lt;NA&gt;  &lt;NA&gt;
## 
## $borders
## Source: local data frame [1 x 19]
## 
##   outline start_present start_style start_color end_present end_style
##     &lt;lgl&gt;         &lt;lgl&gt;       &lt;chr&gt;       &lt;chr&gt;       &lt;lgl&gt;     &lt;chr&gt;
## 1      NA         FALSE        &lt;NA&gt;        &lt;NA&gt;       FALSE      &lt;NA&gt;
## Variables not shown: end_color &lt;chr&gt;, left_present &lt;lgl&gt;, left_style
##   &lt;chr&gt;, left_color &lt;chr&gt;, right_present &lt;lgl&gt;, right_style &lt;chr&gt;,
##   right_color &lt;chr&gt;, top_present &lt;lgl&gt;, top_style &lt;chr&gt;, top_color &lt;chr&gt;,
##   bottom_present &lt;lgl&gt;, bottom_style &lt;chr&gt;, bottom_color &lt;chr&gt;.
## 
## $cell_style_xfs
## Source: local data frame [1 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA       1         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_xfs
## Source: local data frame [2 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA       1         NA        FALSE        FALSE
## 2        NA      NA       2         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_styles
## Source: local data frame [1 x 6]
## 
##   builtin_id custom_builtin hidden i_level   name xf_id
##        &lt;int&gt;          &lt;lgl&gt;  &lt;lgl&gt;   &lt;int&gt;  &lt;chr&gt; &lt;int&gt;
## 1          1          FALSE  FALSE      NA Normal     1
## 
## $num_fmts
## Source: local data frame [0 x 2]
## 
## Variables not shown: num_format_id &lt;int&gt;, format_code &lt;chr&gt;.</code></pre>
<p><code>styles</code> is a list of <code>tbl_df</code>s:</p>
<ul>
<li>fonts: Variables include <code>name</code>, <code>color</code>, <code>sz</code>.</li>
<li>fills: Variables include <code>pattern_type</code> and <code>fg</code>.</li>
<li>borders: Variables include <code>outline</code> and <code>top_color</code>.</li>
<li>num_fmts: Variables are <code>num_format_id</code> and <code>format_code</code>, where the format codes are those things familiar from Excel, such as <code>&quot;$&quot;#,##0.00</code>.</li>
<li><em>stuff below here seems to index into / synthesize the above?</em></li>
<li>cell_style_xfs: tibble of cell styles? Variables include <code>border_id</code>, <code>fill_id</code>, <code>font_id</code>, <code>num_fmt_id</code> (see above), <code>shrink_to_fit</code>, <code>text_wrap</code>.</li>
<li>cell_xfs: <em>what is this? seems to have same variables as cell_style_xfs. But for mini gapminder, this has 2 rows, whereas cell_style_xfs has only one.</em></li>
<li>cell_styles: tibble of cell styles? Variables include <code>builtin_id</code>, <code>name</code>, <code>xf_id</code>.</li>
<li><em>Here’s a mystery node from mini gapminder style xml: <code>&lt;dxfs count=&quot;0&quot;/&gt;</code>. What is that even? This is a typical value (it is missing from Ekaterinburg). This node has much more content in the formulas and formatting sheet. Discuss with Rich.</em></li>
</ul>
<p>Again, Ekaterinburg has different namespace for the XML in <code>styles.xml</code>. I learned this in my now-abandoned effort to look into the styles myself (I got as far as fonts):</p>
<ul>
<li>Typical xlsx has a default namespace for the styles XML.</li>
<li>But Ekaterinburg uses the same (I think?) namespace, <code>http://schemas.openxmlformats.org/spreadsheetml/2006/main</code>, but with prefix <code>x</code>. So that would need to be finessed to read styles out of such sheets.</li>
</ul>
<p>Let’s try to read other styles.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_style</span>(ff_path)</code></pre></div>
<pre><code>## $fonts
## Source: local data frame [4 x 13]
## 
##          name family     b     i strike outline shadow condense extend
##         &lt;chr&gt;  &lt;chr&gt; &lt;lgl&gt; &lt;lgl&gt;  &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;    &lt;lgl&gt;  &lt;lgl&gt;
## 1       Arial   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE
## 2        &lt;NA&gt;   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE
## 3        &lt;NA&gt;   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE
## 4 Courier New   &lt;NA&gt;  TRUE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE
## Variables not shown: color &lt;chr&gt;, sz &lt;dbl&gt;, u &lt;chr&gt;, scheme &lt;chr&gt;.
## 
## $fills
## Source: local data frame [2 x 4]
## 
##      type pattern_type    fg    bg
##     &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 pattern         none  &lt;NA&gt;  &lt;NA&gt;
## 2 pattern    lightGray  &lt;NA&gt;  &lt;NA&gt;
## 
## $borders
## Source: local data frame [1 x 19]
## 
##   outline start_present start_style start_color end_present end_style
##     &lt;lgl&gt;         &lt;lgl&gt;       &lt;chr&gt;       &lt;chr&gt;       &lt;lgl&gt;     &lt;chr&gt;
## 1      NA         FALSE        &lt;NA&gt;        &lt;NA&gt;       FALSE      &lt;NA&gt;
## Variables not shown: end_color &lt;chr&gt;, left_present &lt;lgl&gt;, left_style
##   &lt;chr&gt;, left_color &lt;chr&gt;, right_present &lt;lgl&gt;, right_style &lt;chr&gt;,
##   right_color &lt;chr&gt;, top_present &lt;lgl&gt;, top_style &lt;chr&gt;, top_color &lt;chr&gt;,
##   bottom_present &lt;lgl&gt;, bottom_style &lt;chr&gt;, bottom_color &lt;chr&gt;.
## 
## $cell_style_xfs
## Source: local data frame [1 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA       1         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_xfs
## Source: local data frame [16 x 16]
## 
##    border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##        &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1         NA      NA       1         NA        FALSE        FALSE
## 2         NA      NA       2         NA        FALSE        FALSE
## 3         NA      NA       2          4        FALSE        FALSE
## 4         NA      NA       2          5        FALSE        FALSE
## 5         NA      NA       3         NA        FALSE        FALSE
## 6         NA      NA       2         12        FALSE        FALSE
## 7         NA      NA       2         11        FALSE        FALSE
## 8         NA      NA       2          5        FALSE        FALSE
## 9         NA      NA       2         11        FALSE        FALSE
## 10        NA      NA       2         12        FALSE        FALSE
## 11        NA      NA       4         NA        FALSE        FALSE
## 12        NA      NA       2          3        FALSE        FALSE
## 13        NA      NA       2         13        FALSE        FALSE
## 14        NA      NA       2        165        FALSE        FALSE
## 15        NA      NA       2          4        FALSE        FALSE
## 16        NA      NA       2          4        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_styles
## Source: local data frame [1 x 6]
## 
##   builtin_id custom_builtin hidden i_level   name xf_id
##        &lt;int&gt;          &lt;lgl&gt;  &lt;lgl&gt;   &lt;int&gt;  &lt;chr&gt; &lt;int&gt;
## 1          1          FALSE  FALSE      NA Normal     1
## 
## $num_fmts
## Source: local data frame [1 x 2]
## 
##   num_format_id format_code
##           &lt;int&gt;       &lt;chr&gt;
## 1           165 &quot;$&quot;#,##0.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## as explained above, namespace crazy means this won't work
<span class="co">#xlsx_read_style(ek_path)</span>
<span class="kw">xlsx_read_style</span>(ek2_path)</code></pre></div>
<pre><code>## $fonts
## Source: local data frame [5 x 13]
## 
##      name family     b     i strike outline shadow condense extend   color
##     &lt;chr&gt;  &lt;chr&gt; &lt;lgl&gt; &lt;lgl&gt;  &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;    &lt;lgl&gt;  &lt;lgl&gt;   &lt;chr&gt;
## 1 Calibri  Swiss FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #000000
## 2 Calibri  Swiss  TRUE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #000000
## 3 Calibri  Swiss  TRUE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #44546A
## 4 Calibri  Swiss FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #0000FF
## 5 Calibri  Swiss FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #FF0000
## Variables not shown: sz &lt;dbl&gt;, u &lt;chr&gt;, scheme &lt;chr&gt;.
## 
## $fills
## Source: local data frame [2 x 4]
## 
##      type pattern_type    fg    bg
##     &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 pattern         none  &lt;NA&gt;  &lt;NA&gt;
## 2 pattern      gray125  &lt;NA&gt;  &lt;NA&gt;
## 
## $borders
## Source: local data frame [2 x 19]
## 
##   outline start_present start_style start_color end_present end_style
##     &lt;lgl&gt;         &lt;lgl&gt;       &lt;chr&gt;       &lt;chr&gt;       &lt;lgl&gt;     &lt;chr&gt;
## 1      NA         FALSE        &lt;NA&gt;        &lt;NA&gt;       FALSE      &lt;NA&gt;
## 2      NA         FALSE        &lt;NA&gt;        &lt;NA&gt;       FALSE      &lt;NA&gt;
## Variables not shown: end_color &lt;chr&gt;, left_present &lt;lgl&gt;, left_style
##   &lt;chr&gt;, left_color &lt;chr&gt;, right_present &lt;lgl&gt;, right_style &lt;chr&gt;,
##   right_color &lt;chr&gt;, top_present &lt;lgl&gt;, top_style &lt;chr&gt;, top_color &lt;chr&gt;,
##   bottom_present &lt;lgl&gt;, bottom_style &lt;chr&gt;, bottom_color &lt;chr&gt;.
## 
## $cell_style_xfs
## Source: local data frame [1 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA      NA         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_xfs
## Source: local data frame [7 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA      NA         NA        FALSE        FALSE
## 2         2      NA       2         50        FALSE        FALSE
## 3         2      NA      NA         50        FALSE        FALSE
## 4         2      NA      NA         50        FALSE        FALSE
## 5        NA      NA       3         50        FALSE        FALSE
## 6        NA      NA      NA         NA        FALSE        FALSE
## 7        NA      NA       4         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_styles
## Source: local data frame [1 x 6]
## 
##   builtin_id custom_builtin hidden i_level   name xf_id
##        &lt;int&gt;          &lt;lgl&gt;  &lt;lgl&gt;   &lt;int&gt;  &lt;chr&gt; &lt;int&gt;
## 1          1          FALSE  FALSE      NA Normal     1
## 
## $num_fmts
## Source: local data frame [0 x 2]
## 
## Variables not shown: num_format_id &lt;int&gt;, format_code &lt;chr&gt;.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_style</span>(dn_path)</code></pre></div>
<pre><code>## $fonts
## Source: local data frame [2 x 13]
## 
##    name family     b     i strike outline shadow condense extend   color
##   &lt;chr&gt;  &lt;chr&gt; &lt;lgl&gt; &lt;lgl&gt;  &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;    &lt;lgl&gt;  &lt;lgl&gt;   &lt;chr&gt;
## 1 Arial   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #000000
## 2 Arial   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE    &lt;NA&gt;
## Variables not shown: sz &lt;dbl&gt;, u &lt;chr&gt;, scheme &lt;chr&gt;.
## 
## $fills
## Source: local data frame [2 x 4]
## 
##      type pattern_type    fg    bg
##     &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 pattern         none  &lt;NA&gt;  &lt;NA&gt;
## 2 pattern      gray125  &lt;NA&gt;  &lt;NA&gt;
## 
## $borders
## Source: local data frame [1 x 19]
## 
##   outline start_present start_style start_color end_present end_style
##     &lt;lgl&gt;         &lt;lgl&gt;       &lt;chr&gt;       &lt;chr&gt;       &lt;lgl&gt;     &lt;chr&gt;
## 1      NA         FALSE        &lt;NA&gt;        &lt;NA&gt;       FALSE      &lt;NA&gt;
## Variables not shown: end_color &lt;chr&gt;, left_present &lt;lgl&gt;, left_style
##   &lt;chr&gt;, left_color &lt;chr&gt;, right_present &lt;lgl&gt;, right_style &lt;chr&gt;,
##   right_color &lt;chr&gt;, top_present &lt;lgl&gt;, top_style &lt;chr&gt;, top_color &lt;chr&gt;,
##   bottom_present &lt;lgl&gt;, bottom_style &lt;chr&gt;, bottom_color &lt;chr&gt;.
## 
## $cell_style_xfs
## Source: local data frame [1 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA      NA         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_xfs
## Source: local data frame [2 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA       1         NA        FALSE        FALSE
## 2        NA      NA       2         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_styles
## Source: local data frame [1 x 6]
## 
##   builtin_id custom_builtin hidden i_level   name xf_id
##        &lt;int&gt;          &lt;lgl&gt;  &lt;lgl&gt;   &lt;int&gt;  &lt;chr&gt; &lt;int&gt;
## 1          1          FALSE  FALSE      NA Normal     1
## 
## $num_fmts
## Source: local data frame [0 x 2]
## 
## Variables not shown: num_format_id &lt;int&gt;, format_code &lt;chr&gt;.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_read_style</span>(gabe_path)</code></pre></div>
<pre><code>## $fonts
## Source: local data frame [1 x 13]
## 
##      name family     b     i strike outline shadow condense extend   color
##     &lt;chr&gt;  &lt;chr&gt; &lt;lgl&gt; &lt;lgl&gt;  &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;    &lt;lgl&gt;  &lt;lgl&gt;   &lt;chr&gt;
## 1 Calibri  Swiss FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #000000
## Variables not shown: sz &lt;dbl&gt;, u &lt;chr&gt;, scheme &lt;chr&gt;.
## 
## $fills
## Source: local data frame [2 x 4]
## 
##      type pattern_type    fg    bg
##     &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 pattern         none  &lt;NA&gt;  &lt;NA&gt;
## 2 pattern      gray125  &lt;NA&gt;  &lt;NA&gt;
## 
## $borders
## Source: local data frame [1 x 19]
## 
##   outline start_present start_style start_color end_present end_style
##     &lt;lgl&gt;         &lt;lgl&gt;       &lt;chr&gt;       &lt;chr&gt;       &lt;lgl&gt;     &lt;chr&gt;
## 1      NA         FALSE        &lt;NA&gt;        &lt;NA&gt;       FALSE      &lt;NA&gt;
## Variables not shown: end_color &lt;chr&gt;, left_present &lt;lgl&gt;, left_style
##   &lt;chr&gt;, left_color &lt;chr&gt;, right_present &lt;lgl&gt;, right_style &lt;chr&gt;,
##   right_color &lt;chr&gt;, top_present &lt;lgl&gt;, top_style &lt;chr&gt;, top_color &lt;chr&gt;,
##   bottom_present &lt;lgl&gt;, bottom_style &lt;chr&gt;, bottom_color &lt;chr&gt;.
## 
## $cell_style_xfs
## Source: local data frame [1 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA      NA         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_xfs
## Source: local data frame [1 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA      NA         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $cell_styles
## Source: local data frame [1 x 6]
## 
##   builtin_id custom_builtin hidden i_level   name xf_id
##        &lt;int&gt;          &lt;lgl&gt;  &lt;lgl&gt;   &lt;int&gt;  &lt;chr&gt; &lt;int&gt;
## 1          1          FALSE  FALSE      NA Normal     1
## 
## $num_fmts
## Source: local data frame [0 x 2]
## 
## Variables not shown: num_format_id &lt;int&gt;, format_code &lt;chr&gt;.</code></pre>
</div>
<div id="worksheet-rels-from-xlworksheets_relssheet0-9.xml.rels" class="section level3">
<h3>Worksheet rels from xl/worksheets/_rels/sheet[0-9]*.xml.rels</h3>
<p>There is up to one file per worksheet in <code>xl/worksheets/_rels/</code>. From these we make the tibble <code>worksheet_rels</code>, where each row corresponds to the file for a worksheet. It is possible for a worksheet to have no associated <code>rels</code> file and it is possible for a workbook to have zero worksheet <code>rels</code> files, in which case this object will be <code>NULL</code>.</p>
<p>When this tibble exists, here are the variables:</p>
<ul>
<li>worksheet: character, e.g. “sheet1”. Note: I created this from filename.</li>
<li>id: character, so far typically it’s “rId1”, except for Ekaterinburg, of course</li>
<li>type: uniformly a long name-spacey string ending in “drawing” or “hyperlink”</li>
<li>target: how to get to the thing. So this could be a relative local path to the “drawing” file. Or it could be a URL.</li>
<li>targetmode: “External” when target is a URL, otherwise seems to not exist or be <code>NA</code></li>
</ul>
<p>Let’s just look at these worksheet rels for all of our examples.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.data.frame</span>(worksheet_rels &lt;-<span class="st"> </span><span class="kw">xlsx_read_worksheet_rels</span>(mini_gap_path))</code></pre></div>
<pre><code>##   worksheet   id
## 1    sheet1 rId1
## 2    sheet2 rId1
## 3    sheet3 rId1
## 4    sheet4 rId1
## 5    sheet5 rId1
##                                                                          type
## 1 http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing
## 2 http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing
## 3 http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing
## 4 http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing
## 5 http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing
##                              target
## 1 ../drawings/worksheetdrawing1.xml
## 2 ../drawings/worksheetdrawing2.xml
## 3 ../drawings/worksheetdrawing3.xml
## 4 ../drawings/worksheetdrawing4.xml
## 5 ../drawings/worksheetdrawing5.xml</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.data.frame</span>(<span class="kw">xlsx_read_worksheet_rels</span>(ff_path))</code></pre></div>
<pre><code>##   worksheet   id
## 1    sheet1 rId1
## 2    sheet1 rId2
##                                                                            type
## 1 http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink
## 2   http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing
##                              target targetmode
## 1            http://www.google.com/   External
## 2 ../drawings/worksheetdrawing1.xml       &lt;NA&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.data.frame</span>(<span class="kw">xlsx_read_worksheet_rels</span>(ek_path))</code></pre></div>
<pre><code>##   worksheet
## 1     sheet
##                                                                            type
## 1 http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink
##                      target targetmode                id
## 1 http://spark-interfax.ru/   External R9d4dace81f1f4cc7</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.data.frame</span>(<span class="kw">xlsx_read_worksheet_rels</span>(ek2_path))</code></pre></div>
<pre><code>##   worksheet   id
## 1    sheet1 rId1
##                                                                            type
## 1 http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink
##                      target targetmode
## 1 http://spark-interfax.ru/   External</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.data.frame</span>(<span class="kw">xlsx_read_worksheet_rels</span>(dn_path))</code></pre></div>
<pre><code>## data frame with 0 columns and 0 rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.data.frame</span>(<span class="kw">xlsx_read_worksheet_rels</span>(gabe_path))</code></pre></div>
<pre><code>## data frame with 0 columns and 0 rows</code></pre>
</div>
<div id="drawings-such-as-xldrawingsworksheetdrawing1.xml" class="section level3">
<h3>Drawings such as xl/drawings/worksheetdrawing1.xml</h3>
<p>I am not dealing with this. But want to record that it is typical to see one of these files per worksheet, even where there are no “drawings”, e.g., plots. Case in point: mini Gapminder.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">subset</span>(<span class="kw">xlsx_list_files</span>(mini_gap_path), <span class="kw">grepl</span>(<span class="st">&quot;drawing&quot;</span>, name))</code></pre></div>
<pre><code>## Source: local data frame [5 x 3]
## 
##                                name length                date
##                               &lt;chr&gt;  &lt;dbl&gt;              &lt;time&gt;
## 1 xl/drawings/worksheetdrawing1.xml    494 2015-04-25 12:00:00
## 2 xl/drawings/worksheetdrawing2.xml    494 2015-04-25 12:00:00
## 3 xl/drawings/worksheetdrawing3.xml    494 2015-04-25 12:00:00
## 4 xl/drawings/worksheetdrawing4.xml    494 2015-04-25 12:00:00
## 5 xl/drawings/worksheetdrawing5.xml    494 2015-04-25 12:00:00</code></pre>
</div>
<div id="high-level-info-from-worksheets" class="section level3">
<h3>High-level info from worksheets</h3>
<p>OMG we have finally arrived here! I’m coming back to this soon!</p>
</div>
<div id="putting-it-all-together" class="section level3">
<h3>Putting it all together</h3>
<p>All of the above is bundled together in the function <code>rexcel_register()</code>, which currently returns a list with the assembled components.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mini_gap_workbook &lt;-<span class="st"> </span><span class="kw">rexcel_register</span>(mini_gap_path)
<span class="kw">str</span>(mini_gap_workbook, <span class="dt">max.level =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## List of 11
##  $ xlsx_path     : chr &quot;/Users/jenny/rrr/rexcel/inst/sheets/mini-gap.xlsx&quot;
##  $ reg_time      : POSIXct[1:1], format: &quot;2016-06-09 09:55:44&quot;
##  $ manifest      :Classes 'tbl_df', 'tbl' and 'data.frame':  21 obs. of  3 variables:
##  $ content_types :Classes 'tbl_df', 'tbl' and 'data.frame':  15 obs. of  3 variables:
##  $ sheets        :Classes 'tbl_df', 'tbl' and 'data.frame':  5 obs. of  4 variables:
##  $ defined_names : NULL
##  $ workbook_rels :Classes 'tbl_df', 'tbl' and 'data.frame':  7 obs. of  3 variables:
##  $ shared_strings: atomic [1:33] country continent year lifeExp ...
##   ..- attr(*, &quot;count&quot;)= int 80
##   ..- attr(*, &quot;uniqueCount&quot;)= int 33
##  $ styles        :List of 7
##  $ worksheet_rels:Classes 'tbl_df', 'tbl' and 'data.frame':  5 obs. of  4 variables:
##  $ sheets_df     :Classes 'tbl_df', 'tbl' and 'data.frame':  5 obs. of  5 variables:</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mini_gap_workbook</code></pre></div>
<pre><code>## $xlsx_path
## [1] &quot;/Users/jenny/rrr/rexcel/inst/sheets/mini-gap.xlsx&quot;
## 
## $reg_time
## [1] &quot;2016-06-09 09:55:44 PDT&quot;
## 
## $manifest
## Source: local data frame [21 x 3]
## 
##                                 name length                date
##                                &lt;chr&gt;  &lt;dbl&gt;              &lt;time&gt;
## 1                [Content_Types].xml   2005 2015-04-25 12:00:00
## 2                        _rels/.rels    296 2015-04-25 12:00:00
## 3         xl/_rels/workbook.xml.rels   1129 2015-04-25 12:00:00
## 4  xl/drawings/worksheetdrawing1.xml    494 2015-04-25 12:00:00
## 5  xl/drawings/worksheetdrawing2.xml    494 2015-04-25 12:00:00
## 6  xl/drawings/worksheetdrawing3.xml    494 2015-04-25 12:00:00
## 7  xl/drawings/worksheetdrawing4.xml    494 2015-04-25 12:00:00
## 8  xl/drawings/worksheetdrawing5.xml    494 2015-04-25 12:00:00
## 9               xl/sharedStrings.xml    942 2015-04-25 12:00:00
## 10                     xl/styles.xml   1070 2015-04-25 12:00:00
## ..                               ...    ...                 ...
## 
## $content_types
## Source: local data frame [15 x 3]
## 
##                             part_name extension
##                                 &lt;chr&gt;     &lt;chr&gt;
## 1                                &lt;NA&gt;      rels
## 2                                &lt;NA&gt;       xml
## 3  /xl/drawings/worksheetdrawing4.xml      &lt;NA&gt;
## 4  /xl/drawings/worksheetdrawing2.xml      &lt;NA&gt;
## 5  /xl/drawings/worksheetdrawing1.xml      &lt;NA&gt;
## 6  /xl/drawings/worksheetdrawing3.xml      &lt;NA&gt;
## 7  /xl/drawings/worksheetdrawing5.xml      &lt;NA&gt;
## 8                      /xl/styles.xml      &lt;NA&gt;
## 9               /xl/sharedStrings.xml      &lt;NA&gt;
## 10                   /xl/workbook.xml      &lt;NA&gt;
## 11          /xl/worksheets/sheet5.xml      &lt;NA&gt;
## 12          /xl/worksheets/sheet3.xml      &lt;NA&gt;
## 13          /xl/worksheets/sheet1.xml      &lt;NA&gt;
## 14          /xl/worksheets/sheet4.xml      &lt;NA&gt;
## 15          /xl/worksheets/sheet2.xml      &lt;NA&gt;
## Variables not shown: content_type &lt;chr&gt;.
## 
## $sheets
## Source: local data frame [5 x 4]
## 
##       name   state sheet_id    id
##      &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
## 1   Africa visible        1  rId3
## 2 Americas visible        2  rId4
## 3     Asia visible        3  rId5
## 4   Europe visible        4  rId6
## 5  Oceania visible        5  rId7
## 
## $defined_names
## NULL
## 
## $workbook_rels
## Source: local data frame [7 x 3]
## 
##                  target    id
##                   &lt;chr&gt; &lt;chr&gt;
## 1     sharedStrings.xml  rId2
## 2            styles.xml  rId1
## 3 worksheets/sheet3.xml  rId4
## 4 worksheets/sheet4.xml  rId3
## 5 worksheets/sheet1.xml  rId6
## 6 worksheets/sheet5.xml  rId5
## 7 worksheets/sheet2.xml  rId7
## Variables not shown: type &lt;chr&gt;.
## 
## $shared_strings
##  [1] &quot;country&quot;                &quot;continent&quot;             
##  [3] &quot;year&quot;                   &quot;lifeExp&quot;               
##  [5] &quot;pop&quot;                    &quot;gdpPercap&quot;             
##  [7] &quot;Algeria&quot;                &quot;Africa&quot;                
##  [9] &quot;Angola&quot;                 &quot;Albania&quot;               
## [11] &quot;Europe&quot;                 &quot;Benin&quot;                 
## [13] &quot;Austria&quot;                &quot;Argentina&quot;             
## [15] &quot;Americas&quot;               &quot;Belgium&quot;               
## [17] &quot;Australia&quot;              &quot;Oceania&quot;               
## [19] &quot;Bolivia&quot;                &quot;Bosnia and Herzegovina&quot;
## [21] &quot;New Zealand&quot;            &quot;Bulgaria&quot;              
## [23] &quot;Brazil&quot;                 &quot;Canada&quot;                
## [25] &quot;Afghanistan&quot;            &quot;Asia&quot;                  
## [27] &quot;Bahrain&quot;                &quot;Chile&quot;                 
## [29] &quot;Bangladesh&quot;             &quot;Botswana&quot;              
## [31] &quot;Cambodia&quot;               &quot;China&quot;                 
## [33] &quot;Burkina Faso&quot;          
## attr(,&quot;count&quot;)
## [1] 80
## attr(,&quot;uniqueCount&quot;)
## [1] 33
## 
## $styles
## $styles$fonts
## Source: local data frame [2 x 13]
## 
##    name family     b     i strike outline shadow condense extend   color
##   &lt;chr&gt;  &lt;chr&gt; &lt;lgl&gt; &lt;lgl&gt;  &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;    &lt;lgl&gt;  &lt;lgl&gt;   &lt;chr&gt;
## 1 Arial   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE #000000
## 2  &lt;NA&gt;   &lt;NA&gt; FALSE FALSE  FALSE   FALSE  FALSE    FALSE  FALSE    &lt;NA&gt;
## Variables not shown: sz &lt;dbl&gt;, u &lt;chr&gt;, scheme &lt;chr&gt;.
## 
## $styles$fills
## Source: local data frame [2 x 4]
## 
##      type pattern_type    fg    bg
##     &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 pattern         none  &lt;NA&gt;  &lt;NA&gt;
## 2 pattern    lightGray  &lt;NA&gt;  &lt;NA&gt;
## 
## $styles$borders
## Source: local data frame [1 x 19]
## 
##   outline start_present start_style start_color end_present end_style
##     &lt;lgl&gt;         &lt;lgl&gt;       &lt;chr&gt;       &lt;chr&gt;       &lt;lgl&gt;     &lt;chr&gt;
## 1      NA         FALSE        &lt;NA&gt;        &lt;NA&gt;       FALSE      &lt;NA&gt;
## Variables not shown: end_color &lt;chr&gt;, left_present &lt;lgl&gt;, left_style
##   &lt;chr&gt;, left_color &lt;chr&gt;, right_present &lt;lgl&gt;, right_style &lt;chr&gt;,
##   right_color &lt;chr&gt;, top_present &lt;lgl&gt;, top_style &lt;chr&gt;, top_color &lt;chr&gt;,
##   bottom_present &lt;lgl&gt;, bottom_style &lt;chr&gt;, bottom_color &lt;chr&gt;.
## 
## $styles$cell_style_xfs
## Source: local data frame [1 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA       1         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $styles$cell_xfs
## Source: local data frame [2 x 16]
## 
##   border_id fill_id font_id num_fmt_id pivot_button quote_prefix
##       &lt;int&gt;   &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;lgl&gt;        &lt;lgl&gt;
## 1        NA      NA       1         NA        FALSE        FALSE
## 2        NA      NA       2         NA        FALSE        FALSE
## Variables not shown: apply_protection &lt;lgl&gt;, xf_id &lt;int&gt;, horizontal
##   &lt;chr&gt;, vertical &lt;chr&gt;, indent &lt;int&gt;, justify_last_line &lt;lgl&gt;,
##   reading_order &lt;int&gt;, shrink_to_fit &lt;lgl&gt;, text_rotation &lt;int&gt;, text_wrap
##   &lt;lgl&gt;.
## 
## $styles$cell_styles
## Source: local data frame [1 x 6]
## 
##   builtin_id custom_builtin hidden i_level   name xf_id
##        &lt;int&gt;          &lt;lgl&gt;  &lt;lgl&gt;   &lt;int&gt;  &lt;chr&gt; &lt;int&gt;
## 1          1          FALSE  FALSE      NA Normal     1
## 
## $styles$num_fmts
## Source: local data frame [0 x 2]
## 
## Variables not shown: num_format_id &lt;int&gt;, format_code &lt;chr&gt;.
## 
## 
## $worksheet_rels
## Source: local data frame [5 x 4]
## 
##   worksheet    id
##       &lt;chr&gt; &lt;chr&gt;
## 1    sheet1  rId1
## 2    sheet2  rId1
## 3    sheet3  rId1
## 4    sheet4  rId1
## 5    sheet5  rId1
## Variables not shown: type &lt;chr&gt;, target &lt;chr&gt;.
## 
## $sheets_df
## Source: local data frame [5 x 5]
## 
##   sheet_id     name    id                   target   state
##      &lt;int&gt;    &lt;chr&gt; &lt;chr&gt;                    &lt;chr&gt;   &lt;chr&gt;
## 1        1   Africa  rId3 xl/worksheets/sheet4.xml visible
## 2        2 Americas  rId4 xl/worksheets/sheet3.xml visible
## 3        3     Asia  rId5 xl/worksheets/sheet5.xml visible
## 4        4   Europe  rId6 xl/worksheets/sheet1.xml visible
## 5        5  Oceania  rId7 xl/worksheets/sheet2.xml visible</code></pre>
<p>Let’s review the components:</p>
<ul>
<li><code>xlsx_path</code>: path to the xlsx</li>
<li><code>reg_time</code>: time xlsx was processed</li>
<li><code>manifest</code>: file list for the xlsx zip archive</li>
<li><code>content_types</code>: tbl representing <code>[Content_Types].xml</code></li>
<li><code>sheets</code>: tbl representing <code>xl/workbook.xml</code></li>
<li><code>defined_names</code>: tbl for named ranges</li>
<li><code>workbook_rels</code>: tbl representing <code>xl/_rels/workbook.xml.rels</code>
<ul>
<li>links target files to <code>id</code>s, also gives file type</li>
<li>example: tells you that <code>id = rId4</code> refers to <code>Target</code> file <code>xl/worksheets/sheetX.xml</code></li>
</ul></li>
<li><code>shared_strings</code>: character vector representing <code>xl/sharedStrings.xml</code></li>
<li><code>styles</code>: list of tbls from <code>xl/styles.xml</code></li>
<li><code>worksheet_rels</code>: tbl about files or external resources (URLs) that relate to the worksheets. Comes from files like <code>xl/worksheets/_rels/(sheet[0-9]+).xml.rels</code>.</li>
<li><code>sheets_df</code>:
<ul>
<li>This is arguably the only thing I created.</li>
<li>A tbl with one row per worksheet, from joining <code>sheets</code> and <code>workbook_rels</code></li>
</ul></li>
</ul>
</div>
<div id="relating-this-to-rexcel_read_workbook" class="section level3">
<h3>Relating this to <code>rexcel_read_workbook()</code></h3>
<p>Looking at the innards of <code>rexcel_read_workboobk()</code> to compare and contrast.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path &lt;-<span class="st"> </span>mini_gap_path

dat &lt;-<span class="st"> </span><span class="kw">xlsx_read_workbook</span>(path)
<span class="kw">str</span>(dat, <span class="dt">max.level =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## List of 3
##  $ rels         :Classes 'tbl_df', 'tbl' and 'data.frame':   7 obs. of  4 variables:
##  $ sheets       :'data.frame':   5 obs. of  7 variables:
##  $ defined_names:Classes 'tbl_df', 'tbl' and 'data.frame':   0 obs. of  3 variables:</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat$rels</code></pre></div>
<pre><code>## Source: local data frame [7 x 4]
## 
##      id          type                target               target_abs
##   &lt;chr&gt;         &lt;chr&gt;                 &lt;chr&gt;                    &lt;chr&gt;
## 1  rId2 sharedStrings     sharedStrings.xml     xl/sharedStrings.xml
## 2  rId1        styles            styles.xml            xl/styles.xml
## 3  rId4     worksheet worksheets/sheet3.xml xl/worksheets/sheet3.xml
## 4  rId3     worksheet worksheets/sheet4.xml xl/worksheets/sheet4.xml
## 5  rId6     worksheet worksheets/sheet1.xml xl/worksheets/sheet1.xml
## 6  rId5     worksheet worksheets/sheet5.xml xl/worksheets/sheet5.xml
## 7  rId7     worksheet worksheets/sheet2.xml xl/worksheets/sheet2.xml</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat$sheets</code></pre></div>
<pre><code>##       name sheet_id   state  ref      type                target
## 1   Africa        1 visible rId3 worksheet worksheets/sheet4.xml
## 2 Americas        2 visible rId4 worksheet worksheets/sheet3.xml
## 3     Asia        3 visible rId5 worksheet worksheets/sheet5.xml
## 4   Europe        4 visible rId6 worksheet worksheets/sheet1.xml
## 5  Oceania        5 visible rId7 worksheet worksheets/sheet2.xml
##                 target_abs
## 1 xl/worksheets/sheet4.xml
## 2 xl/worksheets/sheet3.xml
## 3 xl/worksheets/sheet5.xml
## 4 xl/worksheets/sheet1.xml
## 5 xl/worksheets/sheet2.xml</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat$defined_names</code></pre></div>
<pre><code>## Source: local data frame [0 x 3]
## 
## Variables not shown: name &lt;chr&gt;, refers_to &lt;chr&gt;, sheet_id &lt;int&gt;.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## let's look at defined names in a sheet that actually has them
<span class="kw">xlsx_read_workbook</span>(dn_path)$defined_names</code></pre></div>
<pre><code>## Source: local data frame [6 x 3]
## 
##        name refers_to sheet_id
##       &lt;chr&gt;     &lt;chr&gt;    &lt;int&gt;
## 1 continent      &lt;NA&gt;       NA
## 2   country      &lt;NA&gt;       NA
## 3 gdpPercap      &lt;NA&gt;       NA
## 4   lifeExp      &lt;NA&gt;       NA
## 5       pop      &lt;NA&gt;       NA
## 6      year      &lt;NA&gt;       NA</code></pre>
<p><code>dat$rels</code> is what I call <code>workbook_rels</code>.</p>
<p><code>dat$sheets</code> is almost equivalent to my <code>sheets_df</code>.</p>
<p><code>dat$defined_names</code> should be equivalent to my <code>defined_names</code>, but Rich did not anticipate the structure of the nodes I am seeing.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(strings &lt;-<span class="st"> </span><span class="kw">xlsx_read_shared_strings</span>(path))</code></pre></div>
<pre><code>##  [1] &quot;country&quot;                &quot;continent&quot;             
##  [3] &quot;year&quot;                   &quot;lifeExp&quot;               
##  [5] &quot;pop&quot;                    &quot;gdpPercap&quot;             
##  [7] &quot;Algeria&quot;                &quot;Africa&quot;                
##  [9] &quot;Angola&quot;                 &quot;Albania&quot;               
## [11] &quot;Europe&quot;                 &quot;Benin&quot;                 
## [13] &quot;Austria&quot;                &quot;Argentina&quot;             
## [15] &quot;Americas&quot;               &quot;Belgium&quot;               
## [17] &quot;Australia&quot;              &quot;Oceania&quot;               
## [19] &quot;Bolivia&quot;                &quot;Bosnia and Herzegovina&quot;
## [21] &quot;New Zealand&quot;            &quot;Bulgaria&quot;              
## [23] &quot;Brazil&quot;                 &quot;Canada&quot;                
## [25] &quot;Afghanistan&quot;            &quot;Asia&quot;                  
## [27] &quot;Bahrain&quot;                &quot;Chile&quot;                 
## [29] &quot;Bangladesh&quot;             &quot;Botswana&quot;              
## [31] &quot;Cambodia&quot;               &quot;China&quot;                 
## [33] &quot;Burkina Faso&quot;          
## attr(,&quot;count&quot;)
## [1] 80
## attr(,&quot;uniqueCount&quot;)
## [1] 33</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(date_offset &lt;-<span class="st"> </span><span class="kw">xlsx_date_offset</span>(path))</code></pre></div>
<pre><code>## [1] &quot;1899-12-30&quot;</code></pre>
<p><code>strings</code> is my <code>shared_strings</code>.</p>
<p>I don’t have anything like <code>date_offset</code>. Should I?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">style_xlsx &lt;-<span class="st"> </span><span class="kw">xlsx_read_style</span>(path)
<span class="kw">str</span>(style_xlsx, <span class="dt">max.level =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## List of 7
##  $ fonts         :Classes 'tbl_df', 'tbl' and 'data.frame':  2 obs. of  13 variables:
##  $ fills         :Classes 'tbl_df', 'tbl' and 'data.frame':  2 obs. of  4 variables:
##  $ borders       :Classes 'tbl_df', 'tbl' and 'data.frame':  1 obs. of  19 variables:
##  $ cell_style_xfs:Classes 'tbl_df', 'tbl' and 'data.frame':  1 obs. of  16 variables:
##  $ cell_xfs      :Classes 'tbl_df', 'tbl' and 'data.frame':  2 obs. of  16 variables:
##  $ cell_styles   :Classes 'tbl_df', 'tbl' and 'data.frame':  1 obs. of  6 variables:
##  $ num_fmts      :Classes 'tbl_df', 'tbl' and 'data.frame':  0 obs. of  2 variables:</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(lookup &lt;-<span class="st"> </span>tibble::<span class="kw">data_frame</span>(
  <span class="dt">font    =</span> style_xlsx$cell_xfs$font_id,
  <span class="dt">fill    =</span> style_xlsx$cell_xfs$fill_id,
  <span class="dt">border  =</span> style_xlsx$cell_xfs$border_id,
  <span class="dt">num_fmt =</span> style_xlsx$cell_xfs$num_fmt_id))</code></pre></div>
<pre><code>## Source: local data frame [2 x 4]
## 
##    font  fill border num_fmt
##   &lt;int&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt;
## 1     1    NA     NA      NA
## 2     2    NA     NA      NA</code></pre>
<p>Interesting. I hadn’t absorbed that the font, fill, border, and num_fmt tibbles were synced up like this. Good to know. I should proactively check this when I run <code>xlsx_read_workbook()</code> sheets on all the examples systematically.</p>
<p>What are the implications of this? What is the point of <code>lookup</code>? Should we make some giant hairy monster tibble for formatting that has rows like the rows of <code>lookup</code> but cbinds the formatting info from the different domains?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## numeric formatting
n &lt;-<span class="st"> </span><span class="kw">max</span>(style_xlsx$num_fmts$num_format_id)</code></pre></div>
<pre><code>## Warning in max(style_xlsx$num_fmts$num_format_id): no non-missing arguments
## to max; returning -Inf</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fmt &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA_character_</span>, n)</code></pre></div>
<pre><code>## Warning: NAs introduced by coercion to integer range</code></pre>
<pre><code>## Error in rep(NA_character_, n): invalid 'times' argument</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fmt[<span class="kw">seq_along</span>(<span class="kw">xlsx_format_codes</span>())] &lt;-<span class="st"> </span><span class="kw">xlsx_format_codes</span>()</code></pre></div>
<pre><code>## Error in fmt[seq_along(xlsx_format_codes())] &lt;- xlsx_format_codes(): object 'fmt' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fmt[style_xlsx$num_fmts$num_format_id] &lt;-<span class="st"> </span>style_xlsx$num_fmts$format_code</code></pre></div>
<pre><code>## Error in fmt[style_xlsx$num_fmts$num_format_id] &lt;- style_xlsx$num_fmts$format_code: object 'fmt' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">num_fmt &lt;-<span class="st"> </span>tibble::<span class="kw">data_frame</span>(<span class="dt">num_fmt =</span> fmt)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object 'fmt' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">style &lt;-<span class="st"> </span>linen::<span class="kw">linen_style</span>(lookup, <span class="dt">font =</span> style_xlsx$fonts,
                            <span class="dt">fill =</span> style_xlsx$fills,
                            <span class="dt">border =</span> style_xlsx$borders,
                            <span class="dt">num_fmt =</span> num_fmt)</code></pre></div>
<pre><code>## Error in linen::linen_style(lookup, font = style_xlsx$fonts, fill = style_xlsx$fills, : object 'num_fmt' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(workbook &lt;-<span class="st"> </span>linen::<span class="kw">workbook</span>(sheets, style, dat$defined_names))</code></pre></div>
<pre><code>## Error in inherits(style, &quot;linen_style&quot;): object 'style' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sheets &lt;-<span class="st"> </span>1L
(sheets &lt;-<span class="st"> </span><span class="kw">xlsx_sheet_names</span>(dat)[sheets])</code></pre></div>
<pre><code>## [1] &quot;Africa&quot;</code></pre>
<p>Objective 2: Visit and extract information for all requested worksheets.</p>
<p>In this case, I’m just reading the first and only sheet. This loop appears in <code>rexcel_read_workbook()</code> and calls <code>rexcel_read_worksheet()</code> for each requested worksheet. This is the loop and function we eventually exit from and this <code>workbook</code> object is what’s returned.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## enter rexcel_read_worksheet()
## rexcel_read_worksheet(path, s, workbook, dat, strings, style, date_offset)
(sheet &lt;-<span class="st"> </span>sheets[<span class="dv">1</span>])</code></pre></div>
<pre><code>## [1] &quot;Africa&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(sheet_idx &lt;-<span class="st"> </span><span class="kw">match</span>(sheet, workbook$names))</code></pre></div>
<pre><code>## Error in match(sheet, workbook$names): object 'workbook' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(sheet_name &lt;-<span class="st"> </span>sheet)</code></pre></div>
<pre><code>## [1] &quot;Africa&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(target &lt;-<span class="st"> </span><span class="kw">xlsx_internal_sheet_name</span>(sheet, dat))</code></pre></div>
<pre><code>## [1] &quot;xl/worksheets/sheet4.xml&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(rels &lt;-<span class="st"> </span><span class="kw">xlsx_read_rels</span>(path, target))</code></pre></div>
<pre><code>## Source: local data frame [1 x 4]
## 
##      id    type                            target
##   &lt;chr&gt;   &lt;chr&gt;                             &lt;chr&gt;
## 1  rId1 drawing ../drawings/worksheetdrawing4.xml
## Variables not shown: target_abs &lt;chr&gt;.</code></pre>
<p>Now we drop down into a lower-level non-exported function, <code>xlsx_read_sheet()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## enter xlsx_read_sheet()
(file &lt;-<span class="st"> </span><span class="kw">xlsx_internal_sheet_name</span>(sheet_idx, dat))</code></pre></div>
<pre><code>## Error in xlsx_internal_sheet_name(sheet_idx, dat): object 'sheet_idx' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xml &lt;-<span class="st"> </span><span class="kw">xlsx_read_file</span>(path, file) ## at last! the xml! w00t!</code></pre></div>
<pre><code>## Error in utils::unzip(path, file, exdir = tmp): invalid 'files' argument</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(ns &lt;-<span class="st"> </span>xml2::<span class="kw">xml_ns</span>(xml)) ## much less w00t now :(</code></pre></div>
<pre><code>## Error in xml2::xml_ns(xml): object 'xml' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(merged &lt;-<span class="st"> </span><span class="kw">xlsx_read_merged</span>(xml, ns))</code></pre></div>
<pre><code>## Error in xml2::xml_find_first(xml, &quot;d1:mergeCells&quot;, ns): object 'xml' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(view &lt;-<span class="st"> </span><span class="kw">xlsx_ct_worksheet_views</span>(xml, ns))</code></pre></div>
<pre><code>## Error in xml2::xml_find_all(xml, &quot;./d1:sheetViews/d1:sheetView&quot;, ns): object 'xml' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(cols &lt;-<span class="st"> </span><span class="kw">xlsx_ct_cols</span>(xml, ns)) <span class="co"># NOTE: not used yet</span></code></pre></div>
<pre><code>## Error in xml2::xml_find_first(xml, xpath, ns): object 'xml' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## this is where it's at!
(cell_dat &lt;-<span class="st"> </span><span class="kw">xlsx_parse_cells</span>(xml, ns, strings, style, date_offset))</code></pre></div>
<pre><code>## Error in xml2::xml_find_first(xml, &quot;d1:sheetData&quot;, ns): object 'xml' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## not even sure what this is
(rows &lt;-<span class="st"> </span>cell_dat$rows)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object 'cell_dat' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## this is where cells come from  
(cells &lt;-<span class="st"> </span>linen::<span class="kw">cells</span>(cell_dat$cells$ref, cell_dat$cells$style,
                       cell_dat$cells$type, cell_dat$cells$value,
                       cell_dat$cells$formula))</code></pre></div>
<pre><code>## Error in linen::cells(cell_dat$cells$ref, cell_dat$cells$style, cell_dat$cells$type, : object 'cell_dat' not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## in real life and in other sheets, it's possible comments will be populated
## but not in this sheet
comments &lt;-<span class="st"> </span><span class="ot">NULL</span></code></pre></div>
<p>Now we gather everything we’ve learned about this worksheet into a <code>linen::worksheet</code> object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(ws &lt;-<span class="st"> </span>linen::<span class="kw">worksheet</span>(sheet_name, cols, rows, cells, merged, view, comments,
                        workbook))</code></pre></div>
<pre><code>## Error in public_bind_env$initialize(...): object 'rows' not found</code></pre>
<p>If we had other sheets to read, that would be done now. Ultimately this <code>workbook</code> is returned.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
